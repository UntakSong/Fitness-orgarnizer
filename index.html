<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>í”¼íŠ¸ë‹ˆìŠ¤ ì½”ì¹˜ â€“ V7 (ë¹ ë¥¸í¸ì§‘ ëª¨ë‹¬ ë³µêµ¬)</title>
  <meta name="description" content="ì‹¤ë‚´/ë§¨ëª¸/ë‹¬ë¦¬ê¸°/ê±·ê¸°/ì›¨ì´íŠ¸ìš© ë‹¨ì¼ HTML ì•±. ë¹ ë¥¸ì‹œì‘ â†’ ë¹ ë¥¸í¸ì§‘ ëª¨ë‹¬, ë©€í‹° ì‚¬ìš´ë“œ, í…œí”Œë¦¿ ì €ì¥, GPS, íˆìŠ¤í† ë¦¬." />
  <style>
    :root{--bg:#0b0f14;--card:#121922;--ink:#e9f0f7;--muted:#92a2b3;--accent:#2bd576;--accent-2:#54a6ff;--danger:#ff6b6b;--warn:#ffb020;--br:16px;--pad:14px;--pad-lg:16px;--gap:12px;--shadow:0 10px 25px rgba(0,0,0,.25)}
    *{box-sizing:border-box}
    html,body{height:100%} html{color-scheme:dark}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;background:rgba(11,15,20,.85);backdrop-filter:blur(6px);z-index:10;border-bottom:1px solid #141b24}
    .wrap{max-width:980px;margin:0 auto;padding:0 var(--pad-lg)}
    .row{display:flex;gap:var(--gap);flex-wrap:wrap}
    .between{display:flex;align-items:center;justify-content:space-between}
    .nav{display:flex;gap:8px;padding:10px 0;flex-wrap:wrap}
    .nav button{background:#0e141d;border:1px solid #1c2735;color:var(--ink);padding:10px 14px;border-radius:999px;cursor:pointer}
    .nav button[aria-current="page"]{background:var(--accent-2);border-color:transparent;color:#07121f}
    main{padding:18px 0 36px} section{display:none} section.active{display:block}
    .card{background:var(--card);border:1px solid #1b2633;border-radius:var(--br);box-shadow:var(--shadow);padding:var(--pad-lg)}
    .card h3{margin:0 0 8px;font-size:1.1rem}
    .grid{display:grid;gap:var(--gap)} .g2{grid-template-columns:repeat(2,1fr)} .g3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:780px){.g2,.g3{grid-template-columns:1fr}}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;border:1px solid #253241;background:#0e1620;color:var(--ink);font-size:.9rem}
    .btn{appearance:none;border:1px solid #233041;background:#0e1620;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#071b10;font-weight:600}
    .btn.alt{background:#11263a;border-color:#234b73} .btn.warn{background:var(--warn);border-color:transparent;color:#2a1900}
    .btn.danger{background:var(--danger);border-color:transparent;color:#2a0000} .btn.ghost{background:transparent;border-color:#2a3a4d}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    label{display:block;color:var(--muted);font-size:.9rem;margin-bottom:6px}
    input[type=text],input[type=number],select,textarea{width:100%;background:#0d1420;border:1px solid #203046;color:var(--ink);-webkit-text-fill-color:var(--ink);caret-color:var(--ink);padding:10px;border-radius:10px}
    input::placeholder, textarea::placeholder{color:#7f91a3;opacity:1}
    input:focus, select:focus, textarea:focus{outline:0;border-color:var(--accent-2);box-shadow:0 0 0 3px rgba(84,166,255,.15)}
    input[type=number]{appearance:textfield}
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{appearance:none;margin:0}
    table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid #203046;text-align:left} th{color:#a8b5c3;font-weight:600}
    .tiny{font-size:.85rem;color:var(--muted)} .muted{color:var(--muted)} .title{font-size:1.4rem;font-weight:700;letter-spacing:.2px}
    .tag{display:inline-block;padding:3px 8px;border-radius:999px;background:#0b2036;border:1px solid #21486e;color:#9fccff;font-size:.8rem}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .ex-add{display:grid;grid-template-columns:1.3fr .8fr .6fr .6fr .6fr .6fr .7fr auto;gap:8px;align-items:center}
    @media (max-width:980px){.ex-add{grid-template-columns:1fr 1fr 1fr 1fr}}
    .ex-row{display:flex;flex-direction:column;gap:8px}
    .progress{height:10px;background:#0a1320;border:1px solid #1c304a;border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#9effc8)}
    .hint{padding:8px 12px;border:1px dashed #2a3a4d;border-radius:10px;background:#0f1620;color:#a8b5c3}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f1f12;border:1px solid #1e3a26;color:#bff3cc;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .25s}
    .toast.show{opacity:1}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:100}
    .modal.show{display:flex}
    .dialog{width:min(980px,95vw);max-height:90vh;overflow:auto;background:var(--card);border:1px solid #1b2633;border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .dialog header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px}
    .qrows{display:grid;gap:8px}
    .qrow{display:grid;grid-template-columns:1.2fr .7fr .6fr .6fr .6fr .6fr .6fr auto;gap:8px;align-items:end}
    @media (max-width:980px){.qrow{grid-template-columns:1fr 1fr 1fr 1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap between">
      <div class="title">ğŸƒâ€â™‚ï¸ í”¼íŠ¸ë‹ˆìŠ¤ ì½”ì¹˜ <span class="tag">V7</span></div>
      <nav class="nav" aria-label="Sections">
        <button data-goto="workout" aria-current="page">ì›Œí¬ì•„ì›ƒ</button>
        <button data-goto="builder">ë¹Œë”</button>
        <button data-goto="alerts">ì•Œë¦¼</button>
        <button data-goto="history">íˆìŠ¤í† ë¦¬</button>
        <button data-goto="about">ì •ë³´</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- WORKOUT -->
    <section id="workout" class="active grid" aria-label="Workout">
      <div class="hint">ğŸŸ¢ <b>ì›Œí¬ì•„ì›ƒ</b> = ì‹¤í–‰ í™”ë©´. <b>ë¹ ë¥¸ì‹œì‘</b>ì„ ëˆ„ë¥´ë©´ <b>ë¹ ë¥¸í¸ì§‘ ëª¨ë‹¬</b>ì´ ì—´ë¦½ë‹ˆë‹¤.</div>
      <div class="card">
        <h3>ë¹ ë¥¸ ì‹œì‘</h3>
        <div class="row">
          <button class="btn alt" data-template="indoorIntervals">ì‹¤ë‚´ ì¸í„°ë²Œ</button>
          <button class="btn alt" data-template="bodyweight">ë§¨ëª¸ ë£¨í‹´</button>
          <button class="btn alt" data-template="runIntervals">ë‹¬ë¦¬ê¸° ì¸í„°ë²Œ</button>
          <button class="btn alt" data-template="walk30">ê±·ê¸° 30ë¶„</button>
          <button class="btn alt" data-template="weights5x5">ì›¨ì´íŠ¸ 5Ã—5</button>
          <select id="customPick" class="btn" style="padding:10px 10px">
            <option value="">ë‚´ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°â€¦</option>
          </select>
        </div>
        <p class="tiny muted" style="margin-top:8px">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë‚´ìš©ì„ ë¯¸ë¦¬ ë³´ê³  ë°”ë¡œ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>

      <div class="card" aria-live="polite">
        <div class="between"><h3>ì„¸ì…˜ ì§„í–‰</h3><span class="pill"><small>ìƒíƒœ</small> <b id="status">ëŒ€ê¸°</b></span></div>
        <div class="grid g3">
          <div><label>í˜„ì¬ ìš´ë™</label><div id="now-ex" class="pill" style="min-height:38px">-</div></div>
          <div><label>ì„¸íŠ¸</label><div id="now-set" class="pill">-</div></div>
          <div><label>ë°˜ë³µ/ì‹œê°„</label><div id="now-detail" class="pill">-</div></div>
        </div>
        <div style="margin:14px 0"><div class="progress" aria-hidden="true"><i id="bar"></i></div>
          <div class="between tiny muted" style="margin-top:6px"><span id="countdown-label">ë‚¨ì€ ì‹œê°„</span><span id="remaining">00:00</span></div>
        </div>
        <div class="controls">
          <button class="btn primary" id="startBtn">â–¶ ì‹œì‘</button>
          <button class="btn" id="pauseBtn" disabled>â¸ ì¼ì‹œì •ì§€</button>
          <button class="btn ghost" id="skipBtn" disabled>â­ ë‹¤ìŒ</button>
          <button class="btn warn" id="repBtn" disabled>â• ë°˜ë³µ(+1)</button>
          <button class="btn danger" id="resetBtn" disabled>âŸ² ë¦¬ì…‹</button>
        </div>
        <p class="tiny muted" style="margin-top:6px">ë°˜ë³µí˜•ì—ì„œ í…œí¬ê°€ 0ì´ë©´ ìˆ˜ë™ ì¹´ìš´íŠ¸(â•) ë˜ëŠ” ìŠ¤í˜ì´ìŠ¤ë°”.</p>
      </div>

      <div class="card">
        <h3>GPS íŠ¸ë˜í‚¹(ë‹¬ë¦¬ê¸°Â·ê±·ê¸°)</h3>
        <div class="row">
          <button class="btn" id="gpsStart">ğŸ“ ì‹œì‘</button>
          <button class="btn ghost" id="gpsStop" disabled>â–  ì¢…ë£Œ</button>
          <span class="pill"><small>ê±°ë¦¬</small> <b id="gpsDist">0.00 km</b></span>
          <span class="pill"><small>í¬ì¸íŠ¸</small> <b id="gpsPts">0</b></span>
        </div>
        <p class="tiny muted">ìœ„ì¹˜ í—ˆìš© ì‹œ ì¢Œí‘œë¥¼ ê¸°ë¡í•˜ê³  ì´ ê±°ë¦¬ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤(í•˜ë²„ì‚¬ì¸).</p>
      </div>
    </section>

    <!-- BUILDER -->
    <section id="builder" class="grid" aria-label="Builder">
      <div class="hint">ğŸ› ï¸ <b>ë¹Œë”</b> = ì„¤ê³„ í™”ë©´. ìš´ë™ì„ êµ¬ì„±í•˜ê³  í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥/ê´€ë¦¬í•©ë‹ˆë‹¤.</div>
      <div class="card grid g2">
        <div><label for="wname">ì›Œí¬ì•„ì›ƒ ì´ë¦„</label><input id="wname" type="text" placeholder="ì˜ˆ) ë§¨ëª¸ ì „ì‹  20ë¶„" /></div>
        <div class="controls" style="align-self:end;justify-self:end"><button class="btn" id="saveTemplate">ğŸ’¾ í…œí”Œë¦¿ ì €ì¥</button></div>
      </div>

      <div class="card">
        <div class="between" style="margin-bottom:8px"><h3>ìš´ë™ ì¶”ê°€</h3><span class="tiny muted">í•„ë“œ ì‘ì„± í›„ â•</span></div>
        <div class="ex-add" id="addForm">
          <div><label for="exName">ìš´ë™ëª…</label><input id="exName" type="text" placeholder="ì˜ˆ) ìŠ¤ì¿¼íŠ¸ / ëŸ¬ë‹ í•˜ë“œ" /></div>
          <div><label for="exType">ìœ í˜•</label><select id="exType"><option value="reps">ë°˜ë³µ(íšŒ)</option><option value="time">ì‹œê°„(ì´ˆ)</option></select></div>
          <div><label for="exSets">ì„¸íŠ¸</label><input id="exSets" type="number" min="1" step="1" value="3" /></div>
          <div id="repsWrap"><label for="exReps">ë°˜ë³µ(íšŒ)</label><input id="exReps" type="number" min="1" step="1" value="10" /></div>
          <div id="timeWrap" style="display:none"><label for="exSecs">ì‹œê°„(ì´ˆ)</label><input id="exSecs" type="number" min="5" step="5" value="30" /></div>
          <div><label for="exRest">íœ´ì‹(ì´ˆ)</label><input id="exRest" type="number" min="0" step="5" value="30" /></div>
          <div><label for="exTempo">í…œí¬(ì´ˆ/ë°˜ë³µ)</label><input id="exTempo" type="number" min="0" step="0.5" value="2" /></div>
          <div><label for="exWarn">ì„¸íŠ¸ ì¢…ë£Œ ì˜ˆê³ </label><input id="exWarn" type="number" min="0" step="1" value="3" /></div>
          <div style="grid-column:1/-2"><label for="exNote">ë©”ëª¨(ì„ íƒ)</label><input id="exNote" type="text" placeholder="ì˜ˆ) í•˜ì²´ ì§‘ì¤‘" /></div>
          <div style="align-self:end"><button class="btn primary" id="addExercise">â• ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</button></div>
        </div>
        <div id="exList" class="grid" style="gap:8px;margin-top:12px"></div>
      </div>

      <div class="card grid g2" id="tplShelf">
        <div>
          <h3 style="margin-bottom:4px">ìƒì„±ëœ ì›Œí¬ì•„ì›ƒ</h3>
          <p class="tiny muted" id="summary">-</p>
          <div class="controls" style="margin-top:6px"><button class="btn primary" id="loadToRun">â–¶ ì´ëŒ€ë¡œ ì‹œì‘</button><button class="btn ghost" id="clearAll">ğŸ—‘ ì „ì²´ ì§€ìš°ê¸°</button></div>
        </div>
        <div>
          <h3 style="margin-bottom:4px">í…œí”Œë¦¿ ë³´ê´€í•¨</h3>
          <div id="tplList" class="grid" style="gap:6px"></div>
          <p class="tiny muted">ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°/ì‚­ì œê°€ ì—¬ê¸°ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        </div>
      </div>
    </section>

    <!-- ALERTS/TTS -->
    <section id="alerts" aria-label="Alerts" class="grid g2">
      <div class="card">
        <h3>ìŒì„± & ì•Œë¦¼</h3>
        <div class="row">
          <div class="field"><label>ìŒì„± ì•ˆë‚´ ì‚¬ìš©</label><select id="setTTS"><option value="on">ì‚¬ìš©</option><option value="off">ë¯¸ì‚¬ìš©</option></select></div>
          <div class="field"><label>í•œêµ­ì–´ ìŒì„±</label><select id="setVoice"></select></div>
          <div class="field"><label>ì¹´ìš´íŠ¸ ë©˜íŠ¸(ë°˜ë³µí˜•)</label><select id="setCountCall"><option value="on">ì‚¬ìš©</option><option value="off">ë¯¸ì‚¬ìš©</option></select></div>
          <div class="field"><label>í™”ë©´ êº¼ì§ ë°©ì§€</label><select id="setWake"><option value="on">ìš”ì²­</option><option value="off">ìš”ì²­ ì•ˆí•¨</option></select></div>
        </div>
        <div class="row" id="soundRow" style="margin-top:8px">
          <div class="field"><label>ì‹œì‘ ì‚¬ìš´ë“œ</label><select id="soundStart"></select> <button class="btn ghost" id="testStart" title="ë¯¸ë¦¬ë“£ê¸°">ğŸ”Š</button></div>
          <div class="field"><label>ì¢…ë£Œ ì‚¬ìš´ë“œ</label><select id="soundEnd"></select> <button class="btn ghost" id="testEnd" title="ë¯¸ë¦¬ë“£ê¸°">ğŸ”Š</button></div>
          <div class="field"><label>ê²½ê³  ì‚¬ìš´ë“œ</label><select id="soundWarn"></select> <button class="btn ghost" id="testWarn" title="ë¯¸ë¦¬ë“£ê¸°">ğŸ”Š</button></div>
          <div class="field"><label>ì¹´ìš´íŠ¸ ì‚¬ìš´ë“œ</label><select id="soundCount"></select> <button class="btn ghost" id="testCount" title="ë¯¸ë¦¬ë“£ê¸°">ğŸ”Š</button></div>
          <div class="field" style="min-width:220px"><label>ì‚¬ìš´ë“œ ë³¼ë¥¨</label><input id="soundVol" type="range" min="0" max="1" step="0.05" value="0.8"></div>
        </div>
        <p class="tiny muted">ëª¨ë°”ì¼ ì •ì±…ìƒ ì²« ìƒí˜¸ì‘ìš©(â–¶ ì‹œì‘/ğŸ”Š ë¯¸ë¦¬ë“£ê¸°) ì´ì „ì—” ì†Œë¦¬ê°€ ì•ˆ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </section>

    <!-- HISTORY -->
    <section id="history" aria-label="History" class="grid">
      <div class="card">
        <div class="between"><h3>íˆìŠ¤í† ë¦¬</h3>
          <div class="controls"><button class="btn" id="exportData">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button><button class="btn ghost" id="importData">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button><input type="file" id="importFile" class="sr-only" accept="application/json" /></div>
        </div>
        <table aria-describedby="history-desc"><caption id="history-desc" class="sr-only">ì™„ë£Œëœ ì„¸ì…˜ ê¸°ë¡</caption>
          <thead><tr><th>ì¼ì‹œ</th><th>ì´ë¦„</th><th>ì†Œìš”</th><th>ìš”ì•½</th></tr></thead><tbody id="histBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" aria-label="About" class="grid g2">
      <div class="card"><h3>ì •ë³´</h3>
        <ul>
          <li>ì´ íŒŒì¼ì€ <b>ë‹¨ì¼ HTML</b>ë¡œ, ì˜¤í”„ë¼ì¸ì—ì„œë„ ë™ì‘í•©ë‹ˆë‹¤.</li>
          <li>GPS/ì›¨ì´í¬ë½ì€ <b>ë³´ì•ˆ í™˜ê²½(HTTPS/localhost)</b>ì—ì„œë§Œ ë™ì‘í•©ë‹ˆë‹¤. file:// ì—ì„œëŠ” ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.</li>
          <li>iOS/AndroidëŠ” ì²« í„°ì¹˜ í›„ì—ë§Œ TTS/ì‚¬ìš´ë“œê°€ ì¬ìƒë©ë‹ˆë‹¤.</li>
          <li>í™ˆí™”ë©´ ì•± ì„¤ì¹˜(PWA)ëŠ” HTTPSì—ì„œ ì„œë¹„ìŠ¤ì›Œì»¤ë¥¼ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.</li>
        </ul>
      </div>
    </section>
  </main>

  <!-- Quick Edit Modal -->
  <div id="qedit" class="modal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="qeditTitle">
      <header>
        <h3 id="qeditTitle">ë¹ ë¥¸ í¸ì§‘</h3>
        <button class="btn ghost" id="qeditClose">âœ• ë‹«ê¸°</button>
      </header>
      <div class="card grid g2" style="margin-bottom:8px">
        <div><label>ì›Œí¬ì•„ì›ƒ ì´ë¦„</label><input id="q_name" type="text" placeholder="ì˜ˆ) ì»¤ìŠ¤í…€ ë£¨í‹´" /></div>
        <div class="controls" style="align-self:end;justify-self:end"><button class="btn" id="q_add">â• ìš´ë™ ì¶”ê°€</button></div>
      </div>
      <div id="q_list" class="qrows"></div>
      <div class="controls" style="margin-top:10px">
        <button class="btn" id="q_to_builder">ğŸ›  ë¹Œë”ë¡œ ë³´ë‚´ê¸°</button>
        <button class="btn" id="q_save">ğŸ’¾ í…œí”Œë¦¿ ì €ì¥</button>
        <button class="btn primary" id="q_start">â–¶ ì ìš©í•˜ê³  ì‹œì‘</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
  // ===== util
  const $=(s,e=document)=>e.querySelector(s); const $$=(s,e=document)=>Array.from(e.querySelectorAll(s));
  const pad2=n=>String(n).padStart(2,'0'); const fmtClock=s=>`${pad2(Math.floor(s/60))}:${pad2(Math.floor(s%60))}`;
  function toast(msg,ok=true){ const t=$('#toast'); if(!t) return; t.textContent=msg; t.style.background= ok? '#0f1f12':'#2a1212'; t.style.borderColor= ok? '#1e3a26':'#4b1e1e'; t.style.color= ok? '#bff3cc':'#f6c1c1'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); }

  // ===== sound engine (no libs)
  const AC = window.AudioContext || window.webkitAudioContext; let audioCtx=null; function ctx(){ try{ return audioCtx||(audioCtx=new AC()); }catch(e){ return null; } }
  let sound = safeGet('fc_sound',{start:'chime',end:'gong',warn:'beep',count:'beep',volume:0.8});
  function saveSound(){ try{ localStorage.setItem('fc_sound', JSON.stringify(sound)); }catch(e){} }
  function playSound(name){ const c=ctx(); if(!c||name==='none') return; const now=c.currentTime; const out=c.createGain(); out.gain.value=sound.volume; out.connect(c.destination);
    function tone(type,freq,t0,dur,g=1){ const o=c.createOscillator(); const g1=c.createGain(); o.type=type; o.frequency.setValueAtTime(freq, now+t0); g1.gain.setValueAtTime(0, now+t0); g1.gain.linearRampToValueAtTime(g, now+t0+0.01); g1.gain.exponentialRampToValueAtTime(0.0001, now+t0+dur); o.connect(g1); g1.connect(out); o.start(now+t0); o.stop(now+t0+dur+0.05); }
    if(name==='beep'){ tone('sine',740,0,0.18,0.6); }
    else if(name==='chime'){ tone('sine',880,0,0.12,0.7); tone('sine',660,0.14,0.18,0.6); }
    else if(name==='whistle'){ const o=c.createOscillator(); const g=c.createGain(); o.type='sine'; o.frequency.setValueAtTime(1900,now); o.frequency.exponentialRampToValueAtTime(1200,now+0.6); const lfo=c.createOscillator(); const lfoGain=c.createGain(); lfo.type='sine'; lfo.frequency.value=7; lfoGain.gain.value=30; lfo.connect(lfoGain); lfoGain.connect(o.frequency); g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(0.8*sound.volume,now+0.05); g.gain.exponentialRampToValueAtTime(0.0001,now+0.7); o.connect(g); g.connect(out); o.start(now); lfo.start(now); o.stop(now+0.75); lfo.stop(now+0.75); }
    else if(name==='gong'){ [220,330,440,660].forEach((f,i)=>tone('sine',f*1.02,0,0.9+i*0.2,0.5/(i+1))); }
    else if(name==='click'){ const b=c.createBuffer(1,c.sampleRate*0.05,c.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*Math.exp(-i/(d.length*0.6)); } const s=c.createBufferSource(); s.buffer=b; const g=c.createGain(); g.gain.value=0.6*sound.volume; s.connect(g); g.connect(out); s.start(now); }
  }

  // ===== voice / wake
  const voice={enabled:true,countCall:true,voiceURI:null};
  function speak(text){ if(!voice.enabled) return; try{ const u=new SpeechSynthesisUtterance(text); u.rate=1; u.pitch=1; u.lang='ko-KR'; const vs=speechSynthesis.getVoices(); if(voice.voiceURI){const v=vs.find(v=>v.voiceURI===voice.voiceURI); if(v) u.voice=v;} else {const ko=vs.find(v=>v.lang&&v.lang.startsWith('ko')); if(ko) u.voice=ko;} speechSynthesis.speak(u);}catch(e){} }
  const wake={lock:null,want:true}; async function requestWake(){ if(!('wakeLock'in navigator)||!wake.want||!window.isSecureContext) return; try{ wake.lock=await navigator.wakeLock.request('screen'); }catch(e){} }
  document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible'&&!wake.lock){requestWake();} });

  // ===== model (safe localStorage)
  function safeGet(k,fb){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):fb; }catch(e){ return fb; } }
  function safeSet(k,v){ try{ localStorage.setItem(k,JSON.stringify(v)); return true; }catch(e){ console.warn('localStorage ì €ì¥ ì‹¤íŒ¨',e); toast('ì €ì¥ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ì €ì¥ì†Œ ê¶Œí•œ í™•ì¸',false); return false; } }
  let currentWorkout=null; let templates=safeGet('fc_templates',{}); let historyData=safeGet('fc_history',[]);
  function saveTemplates(){ if(safeSet('fc_templates',templates)){ renderTemplateShelf(); refreshCustomPick(); } }
  function saveHistory(){ safeSet('fc_history',historyData); }

  // ===== nav
  $$('.nav button').forEach(b=>b.addEventListener('click',()=>{ const to=b.getAttribute('data-goto'); $$('.nav button').forEach(x=>x.removeAttribute('aria-current')); b.setAttribute('aria-current','page'); $$('main > section').forEach(s=>s.classList.remove('active')); document.getElementById(to).classList.add('active'); }));

  // ===== defaults
  const defaultTemplates={
    indoorIntervals:{name:'ì‹¤ë‚´ ì¸í„°ë²Œ 5ë¼ìš´ë“œ',exercises:[{name:'ë²„í”¼(ê°•í•˜ê²Œ)',type:'time',sets:5,secs:60,rest:30,tempo:0,warn:3,note:''}]},
    bodyweight:{name:'ë§¨ëª¸ ì „ì‹  3ì„¸íŠ¸',exercises:[{name:'í‘¸ì‹œì—…',type:'reps',sets:3,reps:12,rest:30,tempo:2,warn:3,note:''},{name:'ìŠ¤ì¿¼íŠ¸',type:'reps',sets:3,reps:15,rest:30,tempo:2,warn:3,note:''},{name:'í”Œë­í¬',type:'time',sets:3,secs:40,rest:30,tempo:0,warn:5,note:''}]},
    runIntervals:{name:'ë‹¬ë¦¬ê¸° 10Ã—1:1 ì¸í„°ë²Œ',exercises:[{name:'í•˜ë“œ ëŸ¬ë‹',type:'time',sets:10,secs:60,rest:60,tempo:0,warn:5,note:'ìµœëŒ€ì‹¬ë°• 85~90%'}]},
    walk30:{name:'ê±·ê¸° 30ë¶„(5ë¶„ ë¸”ë¡)',exercises:[{name:'ê±·ê¸°',type:'time',sets:6,secs:300,rest:0,tempo:0,warn:10,note:'ìì„¸ ê³§ê²Œ'}]},
    weights5x5:{name:'ìŠ¤ì¿¼íŠ¸ 5Ã—5(90ì´ˆ íœ´ì‹)',exercises:[{name:'ë°”ë²¨ ìŠ¤ì¿¼íŠ¸',type:'reps',sets:5,reps:5,rest:90,tempo:4,warn:3,note:'í¼ ì§‘ì¤‘'}]}
  };

  // ===== Quick Edit Modal (core)
  let qEdit=null;
  function openQuickEditFromKey(key){ const tpl=templates[key]||defaultTemplates[key]; if(!tpl) return alert('í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.'); qEdit=JSON.parse(JSON.stringify(tpl)); const n=$('#q_name'); if(n) n.value=qEdit.name||''; renderQList(); showQEdit(true); }
  function showQEdit(show){ const m=$('#qedit'); if(!m) return; m.classList.toggle('show', !!show); m.setAttribute('aria-hidden', show?'false':'true'); }
  document.addEventListener('click',e=>{ if(e.target && e.target.id==='qedit') showQEdit(false); });
  $('#qeditClose')?.addEventListener('click',()=>showQEdit(false));

  function renderQList(){ const box=$('#q_list'); if(!box) return; box.innerHTML=''; (qEdit?.exercises||[]).forEach((ex,idx)=>{ const row=document.createElement('div'); row.className='qrow'; row.innerHTML=`
      <div><label>ìš´ë™ëª…</label><input type="text" data-k="name" data-i="${idx}" value="${ex.name||''}"></div>
      <div><label>ìœ í˜•</label><select data-k="type" data-i="${idx}"><option value="reps"${ex.type==='reps'?' selected':''}>ë°˜ë³µ</option><option value="time"${ex.type==='time'?' selected':''}>ì‹œê°„</option></select></div>
      <div><label>ì„¸íŠ¸</label><input type="number" min="1" step="1" data-k="sets" data-i="${idx}" value="${ex.sets||1}"></div>
      <div class="q-reps"${ex.type==='reps'?'':' style="display:none"'}><label>ë°˜ë³µ</label><input type="number" min="1" step="1" data-k="reps" data-i="${idx}" value="${ex.reps||10}"></div>
      <div class="q-secs"${ex.type==='time'?'':' style="display:none"'}><label>ì‹œê°„(ì´ˆ)</label><input type="number" min="1" step="1" data-k="secs" data-i="${idx}" value="${ex.secs||30}"></div>
      <div><label>íœ´ì‹(ì´ˆ)</label><input type="number" min="0" step="5" data-k="rest" data-i="${idx}" value="${ex.rest||0}"></div>
      <div><label>í…œí¬</label><input type="number" min="0" step="0.5" data-k="tempo" data-i="${idx}" value="${ex.tempo||0}"></div>
      <div><label>ì˜ˆê³ (ì´ˆ)</label><input type="number" min="0" step="1" data-k="warn" data-i="${idx}" value="${ex.warn||3}"></div>
      <div class="controls" style="grid-column:1/-1;justify-content:flex-end"><button class="btn ghost" data-up="${idx}">â¬†</button><button class="btn ghost" data-down="${idx}">â¬‡</button><button class="btn danger" data-del="${idx}">ì‚­ì œ</button></div>
    `; box.appendChild(row); }); }
  $('#q_list')?.addEventListener('input',e=>{ const t=e.target; const i=+t.dataset.i; const k=t.dataset.k; if(qEdit&&qEdit.exercises[i]){ const v=(t.type==='number')? +t.value : t.value; qEdit.exercises[i][k]=v; if(k==='type'){ renderQList(); } } });
  $('#q_list')?.addEventListener('click',e=>{ const t=e.target; if(t.dataset?.up){ const i=+t.dataset.up; if(i>0){ [qEdit.exercises[i-1],qEdit.exercises[i]]=[qEdit.exercises[i],qEdit.exercises[i-1]]; renderQList(); } }
    if(t.dataset?.down){ const i=+t.dataset.down; if(i<qEdit.exercises.length-1){ [qEdit.exercises[i+1],qEdit.exercises[i]]=[qEdit.exercises[i],qEdit.exercises[i+1]]; renderQList(); } }
    if(t.dataset?.del){ qEdit.exercises.splice(+t.dataset.del,1); renderQList(); }
  });
  $('#q_add')?.addEventListener('click',()=>{ if(!qEdit) qEdit={name:'ì‚¬ìš©ì ì›Œí¬ì•„ì›ƒ',exercises:[]}; qEdit.exercises.push({name:'ìƒˆ ìš´ë™',type:'reps',sets:3,reps:10,secs:30,rest:30,tempo:2,warn:3,note:''}); renderQList(); });
  $('#q_start')?.addEventListener('click',()=>{ if(!qEdit) return; qEdit.name=$('#q_name').value.trim()||(qEdit.name||'ì‚¬ìš©ì ì›Œí¬ì•„ì›ƒ'); currentWorkout=JSON.parse(JSON.stringify(qEdit)); refreshSummary(); showQEdit(false); $$('[data-goto="workout"]').forEach(b=>b.click()); speak(`ìš´ë™ì„ ì‹œì‘í•©ë‹ˆë‹¤. ${currentWorkout.name}`); playSound(sound.start); startSession(); });
  $('#q_save')?.addEventListener('click',()=>{ if(!qEdit) return; const key=prompt('ì €ì¥ í‚¤(ì˜ë¬¸/ìˆ«ì): ì˜ˆ) myQuickA'); if(!key) return; const exists=!!templates[key]; if(exists && !confirm('ê°™ì€ í‚¤ê°€ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì“¸ê¹Œìš”?')) return; const toSave={name:$('#q_name').value.trim()||(qEdit.name||key),exercises:JSON.parse(JSON.stringify(qEdit.exercises))}; templates[key]=toSave; saveTemplates(); toast('í…œí”Œë¦¿ ì €ì¥ ì™„ë£Œ: '+key); });
  $('#q_to_builder')?.addEventListener('click',()=>{ if(!qEdit) return; exList.length=0; qEdit.exercises.forEach(ex=>exList.push(JSON.parse(JSON.stringify(ex)))); $('#wname').value=$('#q_name').value.trim()||(qEdit.name||'ì‚¬ìš©ì ì›Œí¬ì•„ì›ƒ'); renderExList(); refreshSummary(); showQEdit(false); $$('[data-goto="builder"]').forEach(b=>b.click()); });

  // ===== Quick Start wired to Quick Edit
  $$('#workout [data-template]').forEach(b=>b.addEventListener('click',()=>openQuickEditFromKey(b.dataset.template)));
  function refreshCustomPick(){ const sel=$('#customPick'); if(!sel) return; const cur=sel.value; sel.innerHTML='<option value="">ë‚´ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°â€¦</option>'; Object.keys(templates).sort().forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=(templates[k].name||k)+' ('+k+')'; sel.appendChild(o); }); sel.value=cur||''; }
  $('#customPick').addEventListener('change',e=>{ const k=e.target.value; if(!k) return; openQuickEditFromKey(k); e.target.value=''; });

  // ===== builder
  const exType=$('#exType'); const repsWrap=$('#repsWrap'); const timeWrap=$('#timeWrap');
  exType.addEventListener('change',()=>{ const isTime=exType.value==='time'; repsWrap.style.display=isTime?'none':''; timeWrap.style.display=isTime?'':''; });
  const exList=[];
  function renderExList(){ const box=$('#exList'); box.innerHTML=''; exList.forEach((ex,idx)=>{ const row=document.createElement('div'); row.className='card ex-row'; row.innerHTML=`<div class="between"><div><b>${ex.name}</b> <span class="tag">${ex.type==='time'?`${ex.secs}sÃ—${ex.sets}`:`${ex.reps}íšŒÃ—${ex.sets}`}</span> ${ex.note?`<span class=tiny>${ex.note}</span>`:''}</div><div class=controls><button class="btn ghost" data-up=${idx}>â¬†</button><button class="btn ghost" data-down=${idx}>
      â¬‡</button><button class="btn danger" data-del=${idx}>ì‚­ì œ</button></div></div><div class=row><div class=pill><small>ì„¸íŠ¸</small> <b>${ex.sets}</b></div>${ex.type==='time'?`<div class=pill><small>ì‹œê°„</small> <b>${ex.secs}s</b></div>`:`<div class=pill><small>ë°˜ë³µ</small> <b>${ex.reps}íšŒ</b></div>`}<div class=pill><small>íœ´ì‹</small> <b>${ex.rest}s</b></div><div class=pill><small>í…œí¬</small> <b>${ex.tempo}s/íšŒ</b></div><div class=pill><small>ì˜ˆê³ </small> <b>${ex.warn}s</b></div></div>`; box.appendChild(row); }); }
  $('#exList').addEventListener('click',e=>{ const t=e.target; if(!(t instanceof HTMLElement)) return; if(t.dataset.del){ exList.splice(+t.dataset.del,1); renderExList(); refreshSummary(); } if(t.dataset.up){ const i=+t.dataset.up; if(i>0){ [exList[i-1],exList[i]]=[exList[i],exList[i-1]]; renderExList(); } } if(t.dataset.down){ const i=+t.dataset.down; if(i<exList.length-1){ [exList[i+1],exList[i]]=[exList[i],exList[i+1]]; renderExList(); } } });
  $('#addExercise').addEventListener('click',()=>{ const name=$('#exName').value.trim(); if(!name) return alert('ìš´ë™ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); const type=$('#exType').value; const sets=Math.max(1,+$('#exSets').value||1); const reps=Math.max(1,+$('#exReps').value||10); const secs=Math.max(1,+$('#exSecs').value||30); const rest=Math.max(0,+$('#exRest').value||30); const tempo=Math.max(0,+$('#exTempo').value||0); const warn=Math.max(0,+$('#exWarn').value||3); const note=$('#exNote').value.trim(); const item={name,type,sets,reps,secs,rest,tempo,warn,note}; exList.push(item); renderExList(); refreshSummary(); $('#exName').value=''; $('#exNote').value=''; });
  function refreshSummary(){ const w=currentWorkout||{name:$('#wname').value.trim()||'(ì´ë¦„ ì—†ìŒ)',exercises:exList}; const sum=w.exercises.map(ex=>ex.type==='time'?`${ex.name} ${ex.secs}sÃ—${ex.sets}`:`${ex.name} ${ex.reps}íšŒÃ—${ex.sets}`).join(' Â· '); $('#summary').textContent=sum||'-'; }

  // template shelf
  function renderTemplateShelf(){ const box=$('#tplList'); if(!box) return; box.innerHTML=''; const keys=Object.keys(templates); if(keys.length===0){ box.innerHTML='<div class="tiny muted">ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } keys.sort().forEach(k=>{ const t=templates[k]; const el=document.createElement('div'); el.className='between card'; el.style.padding='10px'; el.innerHTML=`<div><b>${t.name||k}</b> <span class="tag">${k}</span><div class="tiny muted">${(t.exercises||[]).length}ê°œ ìš´ë™</div></div><div class=controls><button class="btn" data-load="${k}">ë¶ˆëŸ¬ì˜¤ê¸°</button><button class="btn ghost" data-rename="${k}">ì´ë¦„ë³€ê²½</button><button class="btn danger" data-del="${k}">ì‚­ì œ</button></div>`; box.appendChild(el); }); }
  $('#tplList')?.addEventListener('click',e=>{ const t=e.target; if(!(t instanceof HTMLElement)) return; if(t.dataset.load){ openQuickEditFromKey(t.dataset.load); }
    if(t.dataset.del){ if(confirm('ì‚­ì œí• ê¹Œìš”? '+t.dataset.del)){ delete templates[t.dataset.del]; saveTemplates(); toast('ì‚­ì œí–ˆìŠµë‹ˆë‹¤.'); } }
    if(t.dataset.rename){ const k=t.dataset.rename; const nw=prompt('ìƒˆ ì´ë¦„:', templates[k].name||k); if(nw){ templates[k].name=nw; saveTemplates(); toast('ì´ë¦„ ë³€ê²½ ì™„ë£Œ'); } }
  });
  $('#saveTemplate').addEventListener('click',()=>{ const hasItems = exList.length>0 || (currentWorkout && (currentWorkout.exercises||[]).length>0); if(!hasItems) return alert('ì €ì¥í•  ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤. ë¹Œë”ì— ìš´ë™ì„ ì¶”ê°€í•˜ì„¸ìš”.'); const key = prompt('ì €ì¥ í‚¤(ì˜ë¬¸/ìˆ«ì): ì˜ˆ) myBodyA'); if(!key) return; const exists = !!templates[key]; if(exists && !confirm('ê°™ì€ í‚¤ê°€ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì“¸ê¹Œìš”?')) return; const name=$('#wname').value.trim()||key; const exs = exList.length? exList : currentWorkout.exercises; templates[key] = { name, exercises: JSON.parse(JSON.stringify(exs)) }; saveTemplates(); toast('í…œí”Œë¦¿ ì €ì¥ ì™„ë£Œ: '+key); });

  // ===== runner
  const statusEl=$('#status'); const bar=$('#bar'); const nowEx=$('#now-ex'); const nowSet=$('#now-set'); const nowDetail=$('#now-detail'); const remEl=$('#remaining'); const repBtn=$('#repBtn');
  const runner={i:0,set:1,phase:'idle',rep:0,repsTarget:0,tStart:0,tEnd:0,warnDone:false,paused:false,timer:null,tempo:0};
  function updateUI(){ if(!currentWorkout){ nowEx.textContent='-'; nowSet.textContent='-'; nowDetail.textContent='-'; remEl.textContent='00:00'; if(bar) bar.style.width='0%'; return; } const ex=currentWorkout.exercises[runner.i]; if(!ex){ nowEx.textContent='ì™„ë£Œ'; nowSet.textContent='-'; nowDetail.textContent='-'; return; } nowEx.textContent=`${ex.name} ${runner.phase==='rest'?'(íœ´ì‹)':''}`; nowSet.textContent=`${runner.set} / ${ex.sets}`; nowDetail.textContent=ex.type==='time'?`${ex.secs}s`:`${runner.rep}/${ex.reps}íšŒ`; }
  function startSession(){ if(!currentWorkout){ alert('í…œí”Œë¦¿ì„ ì„ íƒí•˜ê±°ë‚˜ ë¹Œë”ì—ì„œ ìƒì„±í•˜ì„¸ìš”.'); return; } requestWake(); document.body.focus(); if(ctx() && ctx().state==='suspended'){ ctx().resume?.(); } Object.assign(runner,{i:0,set:1,phase:'work',rep:0,repsTarget:0,warnDone:false,paused:false,tempo:0}); statusEl.textContent='ì§„í–‰ ì¤‘'; $('#startBtn').disabled=true; $('#pauseBtn').disabled=false; $('#skipBtn').disabled=false; $('#resetBtn').disabled=false; repBtn.disabled=false; speak(`ìš´ë™ì„ ì‹œì‘í•©ë‹ˆë‹¤. ${currentWorkout.name}`); stepWork(); }
  function stepWork(){ const ex=currentWorkout.exercises[runner.i]; if(!ex) return finishSession(); runner.phase='work'; runner.warnDone=false; if(bar) bar.style.width='0%'; if(ex.type==='time'){ runner.tStart=performance.now(); runner.tEnd=runner.tStart+ex.secs*1000; $('#countdown-label').textContent='ë‚¨ì€ ì‹œê°„'; speak(`${ex.name} ${runner.set}ì„¸íŠ¸ ì‹œì‘`); tick(); } else { runner.rep=0; runner.repsTarget=ex.reps; runner.tempo=ex.tempo||0; $('#countdown-label').textContent='ë°˜ë³µ'; speak(`${ex.name} ${runner.set}ì„¸íŠ¸ ì‹œì‘`); if(voice.countCall&&runner.tempo>0){ scheduleNextRep(); } else { updateUI(); } } }
  function scheduleNextRep(){ const ex=currentWorkout.exercises[runner.i]; if(!ex||runner.phase!=='work') return; if(runner.rep>=runner.repsTarget){ return afterWork(); } runner.timer&&clearTimeout(runner.timer); runner.timer=setTimeout(()=>{ runner.rep++; updateUI(); if(voice.countCall) speak(String(runner.rep)); else playSound(sound.count); if(runner.rep===runner.repsTarget-1){ if(voice.enabled) speak('ë§ˆì§€ë§‰ í•œ ê°œ'); else playSound(sound.count); } if(runner.rep>=runner.repsTarget){ if(ex.warn>0) {speak('ê³§ ì¢…ë£Œí•©ë‹ˆë‹¤'); playSound(sound.warn);} setTimeout(afterWork,350); } else { scheduleNextRep(); } }, Math.max(10,runner.tempo*1000)); }
  function tick(){ if(runner.paused) return; const now=performance.now(); const remain=Math.max(0,runner.tEnd-now); remEl.textContent=fmtClock(remain/1000); const ex=currentWorkout.exercises[runner.i]; const total=ex.secs*1000; const prog=Math.max(0,Math.min(1,1 - remain/total)); if(bar) bar.style.width=`${prog*100}%`; updateUI(); if(!runner.warnDone&&ex.warn>0&&remain/1000<=ex.warn){ runner.warnDone=true; speak('ê³§ ì¢…ë£Œí•©ë‹ˆë‹¤'); playSound(sound.warn); } if(remain<=0){ setTimeout(afterWork,60); return;} runner.timer=requestAnimationFrame(tick); }
  function afterWork(){ const ex=currentWorkout.exercises[runner.i]; if(ex.rest>0){ runner.phase='rest'; runner.warnDone=false; speak('íœ´ì‹ ì‹œì‘'); runner.tStart=performance.now(); runner.tEnd=runner.tStart+ex.rest*1000; $('#countdown-label').textContent='íœ´ì‹ ë‚¨ì€ ì‹œê°„'; tickRest(); } else { nextSetOrExercise(); } }
  function tickRest(){ if(runner.paused) return; const now=performance.now(); const remain=Math.max(0,runner.tEnd-now); remEl.textContent=fmtClock(remain/1000); const ex=currentWorkout.exercises[runner.i]; const total=ex.rest*1000; const prog=Math.max(0,Math.min(1,1 - remain/total)); if(bar) bar.style.width=`${prog*100}%`; updateUI(); if(!runner.warnDone&&ex.warn>0&&remain/1000<=ex.warn){ runner.warnDone=true; speak('ê³§ ë‹¤ìŒ ì„¸íŠ¸ì…ë‹ˆë‹¤'); playSound(sound.warn); } if(remain<=0){ nextSetOrExercise(); return;} runner.timer=requestAnimationFrame(tickRest); }
  function nextSetOrExercise(){ const ex=currentWorkout.exercises[runner.i]; if(runner.set<ex.sets){ runner.set++; stepWork(); } else { runner.i++; runner.set=1; if(runner.i>=currentWorkout.exercises.length) finishSession(); else stepWork(); } }
  function pauseSession(){ if(runner.paused) return resumeSession(); runner.paused=true; statusEl.textContent='ì¼ì‹œì •ì§€'; if(runner.timer){ cancelAnimationFrame(runner.timer); clearTimeout(runner.timer);} }
  function resumeSession(){ runner.paused=false; statusEl.textContent='ì§„í–‰ ì¤‘'; const ex=currentWorkout.exercises[runner.i]; if(!ex) return; if(runner.phase==='work'){ if(ex.type==='time') tick(); else scheduleNextRep(); } else if(runner.phase==='rest') tickRest(); }
  function skip(){ if(!currentWorkout) return; if(runner.timer){ cancelAnimationFrame(runner.timer); clearTimeout(runner.timer);} speak('ìŠ¤í‚µí•©ë‹ˆë‹¤'); nextSetOrExercise(); }
  function resetSession(){ if(runner.timer){ cancelAnimationFrame(runner.timer); clearTimeout(runner.timer);} Object.assign(runner,{i:0,set:1,phase:'idle',rep:0,repsTarget:0,tStart:0,tEnd:0,warnDone:false,paused:false,tempo:0}); statusEl.textContent='ëŒ€ê¸°'; $('#startBtn').disabled=false; $('#pauseBtn').disabled=true; $('#skipBtn').disabled=true; $('#resetBtn').disabled=true; repBtn.disabled=true; updateUI(); if(bar) bar.style.width='0%'; remEl.textContent='00:00'; }
  function finishSession(){ if(runner.timer){ cancelAnimationFrame(runner.timer); clearTimeout(runner.timer);} statusEl.textContent='ì™„ë£Œ'; speak('ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤. ì›Œí¬ì•„ì›ƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); playSound(sound.end); $('#pauseBtn').disabled=true; $('#skipBtn').disabled=true; repBtn.disabled=true; const end=new Date(); historyData.unshift({ts:end.toISOString(),name:currentWorkout?.name||'-',summary:$('#summary').textContent,duration:calcDurationEstimate(currentWorkout)}); historyData=historyData.slice(0,200); saveHistory(); renderHistory(); }
  function calcDurationEstimate(w){ if(!w) return 'â€”'; let s=0; w.exercises.forEach(ex=>{ if(ex.type==='time') s+=(ex.secs+(ex.rest||0))*ex.sets; else s+= (ex.tempo>0?ex.reps*ex.tempo:2*ex.reps)*ex.sets + (ex.rest||0)*ex.sets; }); return fmtClock(s); }

  $('#startBtn').addEventListener('click',startSession); $('#pauseBtn').addEventListener('click',pauseSession); $('#skipBtn').addEventListener('click',skip); $('#resetBtn').addEventListener('click',resetSession);
  document.addEventListener('keydown',e=>{ if(e.code==='Space'&&!repBtn.disabled){ e.preventDefault(); repBtn.click(); } });
  $('#repBtn').addEventListener('click',()=>{ const ex=currentWorkout?.exercises[runner.i]; if(!ex||ex.type!=='reps') return; if(runner.phase!=='work') return; runner.rep++; updateUI(); if(voice.countCall) speak(String(runner.rep)); else playSound(sound.count); if(runner.rep>=ex.reps){ speak('ê³§ ì¢…ë£Œí•©ë‹ˆë‹¤'); playSound(sound.warn); setTimeout(afterWork,300); } });

  // ===== GPS
  const gps={id:null,pts:[],dist:0}; function hav(a,b){ const toR=d=>d*Math.PI/180; const R=6371000; const dLat=toR(b.lat-a.lat), dLon=toR(b.lon-a.lon); const lat1=toR(a.lat), lat2=toR(b.lat); const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(Math.abs(dLon)/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }
  function gpsUpdate(pos){ const p={lat:pos.coords.latitude,lon:pos.coords.longitude,t:Date.now()}; const n=gps.pts.length; if(n>0){ gps.dist+=hav(gps.pts[n-1],p);} gps.pts.push(p); $('#gpsPts').textContent=String(gps.pts.length); $('#gpsDist').textContent=(gps.dist/1000).toFixed(2)+' km'; }
  $('#gpsStart').addEventListener('click',()=>{ if(!navigator.geolocation) return alert('ì´ ê¸°ê¸°ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); if(gps.id) return; gps.pts=[]; gps.dist=0; $('#gpsPts').textContent='0'; $('#gpsDist').textContent='0.00 km'; gps.id=navigator.geolocation.watchPosition(gpsUpdate,console.warn,{enableHighAccuracy:true,maximumAge:2000,timeout:10000}); $('#gpsStart').disabled=true; $('#gpsStop').disabled=false; });
  $('#gpsStop').addEventListener('click',()=>{ if(gps.id){ navigator.geolocation.clearWatch(gps.id); gps.id=null; } $('#gpsStart').disabled=false; $('#gpsStop').disabled=true; alert('ê¸°ë¡ëœ ì¢Œí‘œ ìˆ˜: '+gps.pts.length+'\nì´ ê±°ë¦¬: '+(gps.dist/1000).toFixed(2)+' km'); });

  // ===== history
  function renderHistory(){ const tbody=$('#histBody'); tbody.innerHTML=''; historyData.forEach(it=>{ const tr=document.createElement('tr'); const dt=new Date(it.ts); tr.innerHTML=`<td>${dt.toLocaleString()}</td><td>${it.name}</td><td>${it.duration}</td><td class=muted>${it.summary||''}</td>`; tbody.appendChild(tr); }); }
  renderHistory();
  $('#exportData').addEventListener('click',()=>{ const blob=new Blob([JSON.stringify({templates,historyData},null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='fitness-coach-data.json'; a.click(); URL.revokeObjectURL(a.href); });
  $('#importData').addEventListener('click',()=> $('#importFile').click());
  $('#importFile').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const obj=JSON.parse(fr.result); if(obj.templates) templates=obj.templates; if(obj.historyData) historyData=obj.historyData; saveTemplates(); saveHistory(); renderHistory(); toast('ë°ì´í„° ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.'); }catch(err){ alert('JSON íŒŒì‹± ì‹¤íŒ¨'); } }; fr.readAsText(f); });

  // ===== alerts tab bindings
  function populateVoices(){ const sel=$('#setVoice'); if(!sel) return; sel.innerHTML=''; const vs=speechSynthesis.getVoices(); const opts=vs.filter(v=>v.lang&&v.lang.startsWith('ko')); if(opts.length===0){ const o=document.createElement('option'); o.value=''; o.textContent='(ê¸°ë³¸)'; sel.appendChild(o); return; } opts.forEach(v=>{ const o=document.createElement('option'); o.value=v.voiceURI; o.textContent=v.name+' Â· '+v.lang; sel.appendChild(o); }); if(voice.voiceURI){ sel.value=voice.voiceURI; } }
  speechSynthesis.onvoiceschanged=populateVoices; populateVoices();
  $('#setTTS')?.addEventListener('change',e=>{ voice.enabled=e.target.value==='on'; });
  $('#setVoice')?.addEventListener('change',e=>{ voice.voiceURI=e.target.value||null; });
  $('#setCountCall')?.addEventListener('change',e=>{ voice.countCall=e.target.value==='on'; });
  $('#setWake')?.addEventListener('change',e=>{ wake.want=e.target.value==='on'; if(wake.want) requestWake(); else { try{ wake.lock?.release(); }catch(_e){} wake.lock=null; } });

  // ===== sound selectors
  function bindSoundUI(){ const opts=['none','beep','chime','whistle','gong','click']; function setOptions(sel){ sel.innerHTML=opts.map(v=>`<option value="${v}">${({none:'ì—†ìŒ',beep:'ì‚',chime:'ì°¨ì„',whistle:'í˜¸ë£¨ë¼ê¸°',gong:'ì§•',click:'í´ë¦­'})[v]}</option>`).join(''); }
    const sStart=$('#soundStart'), sEnd=$('#soundEnd'), sWarn=$('#soundWarn'), sCount=$('#soundCount'), sVol=$('#soundVol');
    if(sStart){ setOptions(sStart); setOptions(sEnd); setOptions(sWarn); setOptions(sCount); sStart.value=sound.start; sEnd.value=sound.end; sWarn.value=sound.warn; sCount.value=sound.count; if(sVol) sVol.value=sound.volume;
      sStart.onchange=e=>{sound.start=e.target.value; saveSound();};
      sEnd.onchange=e=>{sound.end=e.target.value; saveSound();};
      sWarn.onchange=e=>{sound.warn=e.target.value; saveSound();};
      sCount.onchange=e=>{sound.count=e.target.value; saveSound();};
      if(sVol) sVol.oninput=e=>{ sound.volume=+e.target.value; saveSound(); };
    }
    $('#testStart')?.addEventListener('click',()=>playSound(sound.start));
    $('#testEnd')?.addEventListener('click',()=>playSound(sound.end));
    $('#testWarn')?.addEventListener('click',()=>playSound(sound.warn));
    $('#testCount')?.addEventListener('click',()=>playSound(sound.count));
  }
  bindSoundUI();

  // ===== init
  function initialRender(){ renderTemplateShelf(); refreshCustomPick(); updateUI(); refreshSummary(); }
  initialRender();
  </script>
</body>
</html>
