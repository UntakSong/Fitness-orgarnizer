<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>í”¼íŠ¸ë‹ˆìŠ¤ ì½”ì¹˜ â€“ V5.7 (ë¼ì´íŠ¸+í¬ì»¤ìŠ¤+PWA)</title>
  <meta name="description" content="ë‹¨ì¼ HTML ì•±. ë¼ì´íŠ¸/ë‹¤í¬, í¬ì»¤ìŠ¤ ëª¨ë“œ, ë¹ ë¥¸í¸ì§‘(ëª¨ë‹¬), í…œí”Œë¦¿, í¬ë ˆì„¼ë„, ì¸ìŠ¤í„´íŠ¸ ë¦¬ì…‹, GPS." />
  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#00C167">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{--bg:#F6FAFF;--card:#FFFFFF;--ink:#0E1726;--muted:#5C6B7B;--accent:#00C167;--accent-2:#2F7CFF;--danger:#FF6B6B;--warn:#FFB020;--br:16px;--pad:14px;--pad-lg:16px;--gap:12px;--line:#E6EEF7;--chip:#EFF6FF;--chip2:#EFFFF6;--shadow:0 12px 30px rgba(9,25,55,.08)}
    html[data-theme="dark"]{--bg:#0b0f14;--card:#121922;--ink:#e9f0f7;--muted:#92a2b3;--accent:#2bd576;--accent-2:#54a6ff;--danger:#ff6b6b;--warn:#ffb020;--line:#1b2633;--chip:#0e1620;--chip2:#0f1f12;--shadow:0 10px 25px rgba(0,0,0,.25)}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,"Noto Sans KR",sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;background:linear-gradient(135deg,#EBFFF6 0%,#ECF2FF 100%);border-bottom:1px solid var(--line);z-index:10}
    html[data-theme="dark"] header{background:rgba(11,15,20,.85);backdrop-filter:blur(6px)}
    .wrap{max-width:980px;margin:0 auto;padding:0 var(--pad-lg)} .between{display:flex;align-items:center;justify-content:space-between} .row{display:flex;gap:var(--gap);flex-wrap:wrap}
    .title{font-size:1.4rem;font-weight:700;letter-spacing:.2px}
    .nav{display:flex;gap:8px;padding:10px 0;flex-wrap:wrap}
    .nav button{background:#fff;border:1px solid var(--line);color:var(--ink);padding:10px 14px;border-radius:999px;cursor:pointer}
    .nav button[aria-current="page"]{background:var(--accent-2);border-color:transparent;color:#07121f}
    main{padding:18px 0 36px} [hidden]{display:none !important}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--br);box-shadow:var(--shadow);padding:var(--pad-lg)} .card h3{margin:0 0 8px;font-size:1.1rem}
    .grid{display:grid;gap:var(--gap)} .g2{grid-template-columns:repeat(2,1fr)} .g3{grid-template-columns:repeat(3,1fr)} @media (max-width:780px){.g2,.g3{grid-template-columns:1fr}}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;border:1px solid var(--line);background:var(--chip);color:var(--ink);font-size:.9rem} .pill small{color:var(--muted)}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#062612;font-weight:700}
    .btn.alt{background:var(--chip);border-color:transparent;border-radius:999px;padding:10px 16px}
    .btn.warn{background:var(--warn);border-color:transparent;color:#2a1900} .btn.danger{background:var(--danger);border-color:transparent;color:#2a0000} .btn.ghost{background:transparent;border:1px dashed var(--line)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    label{display:block;color:var(--muted);font-size:.9rem;margin-bottom:6px}
    input[type=text],input[type=number],select,textarea{width:100%;background:#fff;border:1px solid var(--line);color:var(--ink);padding:10px;border-radius:10px}
    input::placeholder, textarea::placeholder{color:#8aa0b6;opacity:1}
    input:focus, select:focus, textarea:focus{outline:0;border-color:var(--accent-2);box-shadow:0 0 0 3px rgba(47,124,255,.15)}
    .tiny{font-size:.85rem;color:var(--muted)} .hint{padding:8px 12px;border:1px dashed var(--line);border-radius:10px;background:#F3F8FF;color:#3b4b59} html[data-theme="dark"] .hint{background:#0f1620;color:#a8b5c3;border-color:#2a3a4d}
    .progress{height:14px;background:#E9F1FA;border:1px solid var(--line);border-radius:999px;overflow:hidden} .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#7DFFD0)}
    #remaining{font-weight:800;font-size:clamp(48px,9vw,96px)}
    .player.resting{animation:breathe 2.2s linear infinite} .player.warning{animation:breathe 1.2s linear infinite}
    @keyframes breathe{0%{box-shadow:0 0 0 0 rgba(0,193,103,.20)}70%{box-shadow:0 0 0 16px rgba(0,193,103,0)}100%{box-shadow:0 0 0 0 rgba(0,193,103,0)}}
    /* Focus mode: leave only player card visible */
    .focus-mode main .card:not(.player){display:none !important}
  </style>
</head>
<body>
  <header>
    <div class="wrap between">
      <div class="title">ğŸƒâ€â™‚ï¸ í”¼íŠ¸ë‹ˆìŠ¤ ì½”ì¹˜ <span class="tiny" style="margin-left:6px">V5.7</span></div>
      <nav class="nav" aria-label="Sections">
        <button data-goto="workout" aria-current="page">ì›Œí¬ì•„ì›ƒ</button>
        <button data-goto="settings">ì„¤ì •</button>
        <button data-goto="about">ì •ë³´</button>
        <button class="btn ghost" id="themeToggle" title="í…Œë§ˆ ì „í™˜">â˜€ï¸ ì—ë„ˆì§€</button>
        <button id="installBtn" class="btn" style="display:none">ğŸ“² ì„¤ì¹˜</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- WORKOUT -->
    <section id="workout" aria-label="Workout">
      <div class="grid">
        <div class="hint">ğŸŸ¢ ë©”ì¸ í™”ë©´ì…ë‹ˆë‹¤. ë¹ ë¥¸ì‹œì‘ í•­ëª©ì„ ëˆ„ë¥´ë©´ <b>ë¹ ë¥¸í¸ì§‘(ëª¨ë‹¬)</b>ì´ ì—´ë ¤ ì¦‰ì‹œ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆí•  ìˆ˜ ìˆì–´ìš”.</div>

        <div class="card">
          <h3>ë¹ ë¥¸ ì‹œì‘</h3>
          <div class="row">
            <button class="btn alt" data-template="indoorIntervals">ğŸ  ì‹¤ë‚´ ì¸í„°ë²Œ</button>
            <button class="btn alt" data-template="bodyweight">ğŸ’ª ë§¨ëª¸ ë£¨í‹´</button>
            <button class="btn alt" data-template="runIntervals">ğŸƒ ë‹¬ë¦¬ê¸° ì¸í„°ë²Œ</button>
            <button class="btn alt" data-template="walk30">ğŸš¶ ê±·ê¸° 30ë¶„</button>
            <button class="btn alt" data-template="weights5x5">ğŸ‹ï¸ 5Ã—5</button>
            <select id="customPick" class="btn" style="padding:10px 10px"><option value="">ë‚´ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°â€¦</option></select>
          </div>
        </div>

        <div class="card">
          <div class="between" style="margin-bottom:6px">
            <h3>í˜„ì¬ ì›Œí¬ì•„ì›ƒ</h3>
            <div class="row">
              <button class="btn" id="editCurrent">âœ ë¹ ë¥¸í¸ì§‘</button>
              <button class="btn primary" id="quickStart">â–¶ ì´ëŒ€ë¡œ ì‹œì‘</button>
              <button class="btn ghost" id="clearCurrent">ğŸ—‘ ì „ì²´ ì§€ìš°ê¸°</button>
            </div>
          </div>
          <p class="tiny" id="summary">-</p>
        </div>

        <div class="card player" aria-live="polite">
          <div class="between"><h3>ì„¸ì…˜ ì§„í–‰</h3><div class="row"><button class="btn ghost" id="focusToggle">ğŸ‘ï¸ í¬ì»¤ìŠ¤</button><span class="pill"><small>ìƒíƒœ</small> <b id="status">ëŒ€ê¸°</b></span></div></div>
          <div class="grid g3">
            <div><label>í˜„ì¬ ìš´ë™</label><div id="now-ex" class="pill" style="min-height:38px">-</div></div>
            <div><label>ì„¸íŠ¸</label><div id="now-set" class="pill">-</div></div>
            <div><label>ë°˜ë³µ/ì‹œê°„</label><div id="now-detail" class="pill">-</div></div>
          </div>
          <div style="margin:14px 0"><div class="progress" aria-hidden="true"><i id="bar"></i></div>
            <div class="between tiny" style="margin-top:6px;color:var(--muted)"><span id="countdown-label">ë‚¨ì€ ì‹œê°„</span><span id="remaining">00:00</span></div>
          </div>
          <div class="row">
            <button class="btn primary" id="startBtn">â–¶ ì‹œì‘</button>
            <button class="btn" id="pauseBtn" disabled>â¸ ì¼ì‹œì •ì§€</button>
            <button class="btn ghost" id="skipBtn" disabled>â­ ë‹¤ìŒ</button>
            <button class="btn warn" id="repBtn" disabled>â• ë°˜ë³µ(+1)</button>
            <button class="btn danger" id="resetBtn" disabled>âŸ² ë¦¬ì…‹</button>
          </div>
        </div>

        <div class="card">
          <h3>í…œí”Œë¦¿ ë³´ê´€í•¨</h3>
          <div id="tplList" class="grid" style="gap:6px"></div>
          <p class="tiny">ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°/ì‚­ì œ/ì´ë¦„ë³€ê²½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        </div>

        <div class="card">
          <h3>GPS íŠ¸ë˜í‚¹(ë‹¬ë¦¬ê¸°Â·ê±·ê¸°)</h3>
          <div class="row">
            <button class="btn" id="gpsStart">ğŸ“ ì‹œì‘</button>
            <button class="btn ghost" id="gpsStop" disabled>â–  ì¢…ë£Œ</button>
            <span class="pill"><small>ê±°ë¦¬</small> <b id="gpsDist">0.00 km</b></span>
            <span class="pill"><small>í¬ì¸íŠ¸</small> <b id="gpsPts">0</b></span>
          </div>
          <p class="tiny">ìœ„ì¹˜ í—ˆìš© ì‹œ ì¢Œí‘œë¥¼ ê¸°ë¡í•˜ê³  ì´ ê±°ë¦¬ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤(í•˜ë²„ì‚¬ì¸).</p>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" aria-label="Settings" hidden>
      <div class="grid g2">
        <div class="card">
          <h3>ì„¤ì •</h3>
          <div class="row">
            <div class="field"><label>ìŒì„± ì•ˆë‚´</label><select id="setTTS"><option value="on">ì‚¬ìš©</option><option value="off">ë¯¸ì‚¬ìš©</option></select></div>
            <div class="field"><label>í•œêµ­ì–´ ìŒì„±</label><select id="setVoice"></select></div>
            <div class="field"><label>ì¹´ìš´íŠ¸ ë©˜íŠ¸(ë°˜ë³µí˜•)</label><select id="setCountCall"><option value="on">ì‚¬ìš©</option><option value="off">ë¯¸ì‚¬ìš©</option></select></div>
            <div class="field"><label>ì„¸íŠ¸ ì¢…ë£Œ ì˜ˆê³ (ì´ˆ)</label><input id="setWarn" type="number" min="0" step="1" value="3" /></div>
          </div>
          <p class="tiny">ë¸Œë¼ìš°ì € ì •ì±…ìƒ ì²« ì‚¬ìš©ì ì¡°ì‘ ì´í›„ì—ë§Œ ì†Œë¦¬ê°€ ë‚©ë‹ˆë‹¤.</p>
        </div>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" aria-label="About" hidden>
      <div class="grid g2">
        <div class="card"><h3>ì •ë³´</h3>
          <ul>
            <li>ë‹¨ì¼ HTML íŒŒì¼, ì˜¤í”„ë¼ì¸ ë™ì‘.</li>
            <li>Android/iOS: ì²« ì‚¬ìš©ì ì¡°ì‘ ì´í›„ ì˜¤ë””ì˜¤ í™œì„±í™”.</li>
            <li>ì„¤ì •/ì •ë³´ íƒ­ì€ ì›Œí¬ì•„ì›ƒê³¼ <b>ìƒí˜¸ë°°íƒ€</b>ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <!-- Quick Edit Modal -->
  <div id="qeModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="between" style="margin-bottom:6px"><h3>ë¹ ë¥¸ í¸ì§‘</h3><button class="btn ghost" id="qeClose">âœ–</button></div>
      <div class="grid g2" style="margin-bottom:8px">
        <div><label>ë£¨í‹´ ì´ë¦„</label><input id="qeName" type="text" placeholder="ì›Œí¬ì•„ì›ƒ ì´ë¦„"/></div>
        <div class="row" style="align-self:end;justify-self:end"><button class="btn" id="qeAdd">â• ìš´ë™ ì¶”ê°€</button><button class="btn" id="qeSave">ğŸ’¾ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</button></div>
      </div>
      <div style="overflow:auto">
        <table class="qe-table" id="qeTable">
          <thead><tr><th>ìš´ë™ëª…</th><th>ìœ í˜•</th><th>ì„¸íŠ¸</th><th>ë°˜ë³µ/ì´ˆ</th><th>íœ´ì‹(ì´ˆ)</th><th>í…œí¬</th><th>ì˜ˆê³ </th><th>ë©”ëª¨</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" id="qeApply">ì ìš©</button>
        <button class="btn primary" id="qeApplyStart">â–¶ ì ìš©í•˜ê³  ì‹œì‘</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <style>
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:30}
    .modal.show{display:flex} .sheet{width:min(980px,95vw);max-height:90vh;overflow:auto;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .qe-table th,.qe-table td{white-space:nowrap} .qe-table input[type=number]{width:90px} .qe-table input[type=text]{min-width:160px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0f1f12;border:1px solid #1e3a26;color:#bff3cc;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .25s}
    .toast.show{opacity:1}
  </style>

  <script>
  const $=(s,e=document)=>e.querySelector(s); const $$=(s,e=document)=>Array.from(e.querySelectorAll(s));
  const pad2=n=>String(n).padStart(2,'0'); const fmtClock=s=>`${pad2(Math.floor(s/60))}:${pad2(Math.floor(s%60))}`;
  function toast(msg,ok=true){ const t=$('#toast'); if(!t) return; t.textContent=msg; t.style.background= ok? '#0f1f12':'#2a1212'; t.style.borderColor= ok? '#1e3a26':'#4b1e1e'; t.style.color= ok? '#bff3cc':'#f6c1c1'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); }

  // Tabs (mutually exclusive)
  function showSection(id){ $$('main > section').forEach(s=> s.hidden=true); const el=document.getElementById(id); if(el) el.hidden=false; $$('.nav button').forEach(b=> b.removeAttribute('aria-current')); const btn=document.querySelector('.nav button[data-goto="'+id+'"]'); if(btn) btn.setAttribute('aria-current','page'); }
  $$('.nav button[data-goto]').forEach(b=> b.addEventListener('click',()=> showSection(b.dataset.goto))); showSection('workout');

  // Theme toggle
  (function(){ const key='fc_theme'; const saved=localStorage.getItem(key)||'light'; document.documentElement.setAttribute('data-theme',saved); const btn=$('#themeToggle'); const label=t=> t==='dark'? 'â˜¾ ì•¼ê°„':'â˜€ï¸ ì—ë„ˆì§€'; btn.textContent=label(saved); btn.addEventListener('click',()=>{ const cur=document.documentElement.getAttribute('data-theme'); const next=cur==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme',next); localStorage.setItem(key,next); btn.textContent=label(next); }); })();

  // Focus mode (hide non-player cards)
  (function(){ const btn=$('#focusToggle'); if(!btn) return; const setLabel=on=> btn.textContent= on? 'ğŸ‘ï¸ í¬ì»¤ìŠ¤ í•´ì œ':'ğŸ‘ï¸ í¬ì»¤ìŠ¤'; setLabel(false); btn.addEventListener('click',()=>{ const on=!document.body.classList.contains('focus-mode'); document.body.classList.toggle('focus-mode',on); setLabel(on); }); })();
  function markPlayerState(kind){ const el=document.querySelector('.player'); if(!el) return; el.classList.toggle('resting',kind==='rest'); el.classList.toggle('warning',kind==='warn'); if(!kind){ el.classList.remove('resting','warning'); } }

  // Audio (crescendo, louder)
  let AC=null, MASTER=null; function ensureAC(){ if(AC) return AC; const C=window.AudioContext||window.webkitAudioContext; if(!C) return null; AC=new C(); MASTER=AC.createGain(); MASTER.gain.value=0.9; MASTER.connect(AC.destination); return AC; }
  function beep(ms=180,freq=800,gain=0.35){ try{ const ac=ensureAC(); if(!ac) return; const o=ac.createOscillator(); const g=ac.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(MASTER); const now=ac.currentTime; g.gain.setValueAtTime(gain, now); g.gain.exponentialRampToValueAtTime(0.0001, now+ms/1000); o.start(now); o.stop(now+ms/1000+0.02);}catch(e){} }
  function crescendo(kind='end'){ const Fs= kind==='start'? [900,1100,1300] : [700,900,1100]; const Gs=[0.32,0.42,0.52]; [0,1,2].forEach(i=> setTimeout(()=> beep(170, Fs[i], Gs[i]), i*1000)); }

  // Speech
  const voice={enabled:true,countCall:true,voiceURI:null,warnSec:3};
  function speak(text){ if(!voice.enabled) return; try{ const u=new SpeechSynthesisUtterance(text); u.lang='ko-KR'; u.rate=1; u.pitch=1; const vs=speechSynthesis.getVoices(); if(voice.voiceURI){ const v=vs.find(v=>v.voiceURI===voice.voiceURI); if(v) u.voice=v; } else { const ko=vs.find(v=>v.lang&&v.lang.startsWith('ko')); if(ko) u.voice=ko; } speechSynthesis.speak(u);}catch(e){} }
  function cue(t){ speak(t); beep(); }

  // Storage
  function safeGet(k,fb){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):fb; }catch(e){ return fb; } }
  function safeSet(k,v){ try{ localStorage.setItem(k,JSON.stringify(v)); return true; }catch(e){ console.warn('localStorage ì €ì¥ ì‹¤íŒ¨',e); toast('ì €ì¥ ì‹¤íŒ¨: ì €ì¥ì†Œ ê¶Œí•œ í™•ì¸',false); return false; } }
  let currentWorkout=null; let templates=safeGet('fc_templates',{});
  function saveTemplates(){ if(safeSet('fc_templates',templates)){ renderTemplateShelf(); refreshCustomPick(); } }

  // Defaults
  const defaultTemplates={
    indoorIntervals:{name:'ì‹¤ë‚´ ì¸í„°ë²Œ 5ë¼ìš´ë“œ',exercises:[{name:'ë²„í”¼(ê°•í•˜ê²Œ)',type:'time',sets:5,secs:60,rest:30,tempo:0,warn:3,note:''}]},
    bodyweight:{name:'ë§¨ëª¸ ì „ì‹  3ì„¸íŠ¸',exercises:[{name:'í‘¸ì‹œì—…',type:'reps',sets:3,reps:12,rest:30,tempo:2,warn:3,note:''},{name:'ìŠ¤ì¿¼íŠ¸',type:'reps',sets:3,reps:15,rest:30,tempo:2,warn:3,note:''},{name:'í”Œë­í¬',type:'time',sets:3,secs:40,rest:30,tempo:0,warn:5,note:''}]},
    runIntervals:{name:'ë‹¬ë¦¬ê¸° 10Ã—1:1 ì¸í„°ë²Œ',exercises:[{name:'í•˜ë“œ ëŸ¬ë‹',type:'time',sets:10,secs:60,rest:60,tempo:0,warn:5,note:'ìµœëŒ€ì‹¬ë°• 85~90%'}]},
    walk30:{name:'ê±·ê¸° 30ë¶„(5ë¶„ ë¸”ë¡)',exercises:[{name:'ê±·ê¸°',type:'time',sets:6,secs:300,rest:0,tempo:0,warn:10,note:'ìì„¸ ê³§ê²Œ'}]},
    weights5x5:{name:'ìŠ¤ì¿¼íŠ¸ 5Ã—5(90ì´ˆ íœ´ì‹)',exercises:[{name:'ë°”ë²¨ ìŠ¤ì¿¼íŠ¸',type:'reps',sets:5,reps:5,rest:90,tempo:4,warn:3,note:'í¼ ì§‘ì¤‘'}]}
  };

  // Quick Edit Modal
  let qeData=null; const qeModal=$('#qeModal'); const qeTBody=$('#qeTable tbody');
  function openQuickEdit(src){ const tpl = typeof src==='string'? (templates[src]||defaultTemplates[src]) : src; if(!tpl){ alert('í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
    qeData=JSON.parse(JSON.stringify(tpl)); $('#qeName').value=qeData.name||''; renderQE(); showQE(true); }
  function showQE(on){ qeModal.classList.toggle('show',!!on); qeModal.setAttribute('aria-hidden', on? 'false':'true'); document.body.style.overflow= on? 'hidden':''; }
  function renderQE(){ if(!qeData) return; qeTBody.innerHTML=''; (qeData.exercises||[]).forEach((ex,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`
      <td><input type="text" data-k="name" value="${ex.name||''}"/></td>
      <td><select data-k="type"><option value="reps" ${ex.type==='reps'?'selected':''}>ë°˜ë³µ</option><option value="time" ${ex.type==='time'?'selected':''}>ì‹œê°„</option></select></td>
      <td><input type="number" min="1" step="1" data-k="sets" value="${ex.sets||1}"/></td>
      <td><input type="number" min="1" step="1" data-k="qty" value="${ex.type==='time'?(ex.secs||30):(ex.reps||10)}"/></td>
      <td><input type="number" min="0" step="1" data-k="rest" value="${ex.rest||0}"/></td>
      <td><input type="number" min="0" step="0.5" data-k="tempo" value="${ex.tempo||0}"/></td>
      <td><input type="number" min="0" step="1" data-k="warn" value="${ex.warn||3}"/></td>
      <td><input type="text" data-k="note" value="${ex.note||''}"/></td>
      <td><button class="btn danger" data-del="${i}">ì‚­ì œ</button></td>`; qeTBody.appendChild(tr); }); }
  qeTBody.addEventListener('input', (e)=>{ if(!qeData) return; const el=e.target; if(!(el instanceof HTMLElement)) return; const tr=el.closest('tr'); if(!tr) return; const idx=[...qeTBody.children].indexOf(tr); const k=el.getAttribute('data-k'); if(idx<0||!k) return; const ex=qeData.exercises[idx]; if(k==='qty'){ if(ex.type==='time'){ ex.secs=Math.max(1, +el.value||1); } else { ex.reps=Math.max(1, +el.value||1); } }
    else if(k==='type'){ const v=el.value; ex.type=v; if(v==='time'){ ex.secs=ex.secs||30; } else { ex.reps=ex.reps||10; } renderQE(); }
    else { ex[k] = (el.type==='number')? +el.value : el.value; }
  });
  qeTBody.addEventListener('click',(e)=>{ const t=e.target; if(!(t instanceof HTMLElement)) return; if(t.dataset.del){ qeData.exercises.splice(+t.dataset.del,1); renderQE(); }});
  $('#qeAdd').addEventListener('click',()=>{ if(!qeData) return; qeData.exercises.push({name:'ìƒˆ ìš´ë™',type:'reps',sets:3,reps:10,rest:30,tempo:2,warn:3,note:''}); renderQE(); });
  $('#qeClose').addEventListener('click',()=> showQE(false));
  qeModal.addEventListener('click',(e)=>{ if(e.target===qeModal) showQE(false); });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && qeModal.classList.contains('show')) showQE(false); });
  function fromQE(){ if(!qeData) return null; const name=$('#qeName').value.trim() || qeData.name || 'ì‚¬ìš©ì ì›Œí¬ì•„ì›ƒ'; const exs=qeData.exercises.filter(x=>x&&x.name&&x.sets>0).map(x=>({ name:x.name.trim(), type:x.type==='time'?'time':'reps', sets:Math.max(1, +x.sets||1), reps:x.type==='reps'? Math.max(1, +x.reps||+x.qty||10):undefined, secs:x.type==='time'? Math.max(1, +x.secs||+x.qty||30):undefined, rest:Math.max(0, +x.rest||0), tempo:Math.max(0, +x.tempo||0), warn:Math.max(0, +x.warn||0), note:(x.note||'').trim() })); if(exs.length===0){ alert('ìš´ë™ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'); return null; } return {name,exercises:exs}; }
  function applyQE(startNow=false){ const w=fromQE(); if(!w) return; currentWorkout=w; refreshSummary(); showQE(false); toast('ì›Œí¬ì•„ì›ƒ ì ìš© ì™„ë£Œ'); cue('ì›Œí¬ì•„ì›ƒì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.'); if(startNow){ showSection('workout'); try{ ensureAC(); speak(`ìš´ë™ì„ ì‹œì‘í•©ë‹ˆë‹¤. ${w.name}`); }catch(_){ } startSession(); } }
  $('#qeApply').addEventListener('click',()=>applyQE(false));
  $('#qeApplyStart').addEventListener('click',()=>applyQE(true));
  $('#qeSave').addEventListener('click',()=>{ const w=fromQE(); if(!w) return; const key=prompt('ì €ì¥ í‚¤(ì˜ë¬¸/ìˆ«ì): ì˜ˆ) myBodyA'); if(!key) return; const exists=!!templates[key]; if(exists && !confirm('ë®ì–´ì“¸ê¹Œìš”?')) return; const name=w.name||key; const exs=w.exercises; templates[key]={name,exercises:exs}; saveTemplates(); toast('í…œí”Œë¦¿ ì €ì¥ ì™„ë£Œ: '+key); });

  // Quick Start wiring
  $$('#workout [data-template]').forEach(b=>b.addEventListener('click',()=> openQuickEdit(b.dataset.template)));
  function refreshCustomPick(){ const sel=$('#customPick'); const cur=sel.value; sel.innerHTML='<option value="">ë‚´ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°â€¦</option>'; Object.keys(templates).sort().forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=(templates[k].name||k)+' ('+k+')'; sel.appendChild(o); }); sel.value=cur||''; }
  $('#customPick').addEventListener('change',e=>{ const k=e.target.value; if(!k) return; openQuickEdit(k); e.target.value=''; });

  // Summary & shelf
  function refreshSummary(){ const w=currentWorkout; const sum=w? w.exercises.map(ex=>ex.type==='time'?`${ex.name} ${ex.secs}sÃ—${ex.sets}`:`${ex.name} ${ex.reps}íšŒÃ—${ex.sets}`).join(' Â· ') : '-'; $('#summary').textContent = w? `${w.name} â€” ${sum}` : '-'; }
  function renderTemplateShelf(){ const box=$('#tplList'); box.innerHTML=''; const keys=Object.keys(templates); if(keys.length===0){ box.innerHTML='<div class="tiny">ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } keys.sort().forEach(k=>{ const t=templates[k]; const el=document.createElement('div'); el.className='between card'; el.style.padding='10px'; el.innerHTML=`<div><b>${t.name||k}</b> <span class="tiny" style="opacity:.7">${k}</span><div class="tiny" style="color:var(--muted)">${(t.exercises||[]).length}ê°œ ìš´ë™</div></div><div class="row"><button class="btn" data-load="${k}">ë¶ˆëŸ¬ì˜¤ê¸°</button><button class="btn ghost" data-rename="${k}">ì´ë¦„ë³€ê²½</button><button class="btn danger" data-del="${k}">ì‚­ì œ</button></div>`; box.appendChild(el); }); }
  $('#tplList')?.addEventListener('click',e=>{ const t=e.target; if(!(t instanceof HTMLElement)) return; if(t.dataset.load){ const key=t.dataset.load; const tpl=templates[key]; if(!tpl) return; currentWorkout=JSON.parse(JSON.stringify(tpl)); refreshSummary(); showSection('workout'); toast('ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤'); }
    if(t.dataset.del){ if(confirm('ì‚­ì œí• ê¹Œìš”? '+t.dataset.del)){ delete templates[t.dataset.del]; saveTemplates(); toast('ì‚­ì œí–ˆìŠµë‹ˆë‹¤.'); } }
    if(t.dataset.rename){ const k=t.dataset.rename; const nw=prompt('ìƒˆ ì´ë¦„:', templates[k].name||k); if(nw){ templates[k].name=nw; saveTemplates(); toast('ì´ë¦„ ë³€ê²½ ì™„ë£Œ'); } }
  });

  // Runner
  const statusEl=$('#status'); const bar=$('#bar'); const nowEx=$('#now-ex'); const nowSet=$('#now-set'); const nowDetail=$('#now-detail'); const remEl=$('#remaining'); const repBtn=$('#repBtn');
  const runner={i:0,set:1,phase:'idle',rep:0,repsTarget:0,tStart:0,tEnd:0,warnDone:false,paused:false,timer:null,tempo:0,startSeqFired:false,endSeqFired:false,gen:0};
  function updateUI(){ if(!currentWorkout){ nowEx.textContent='-'; nowSet.textContent='-'; nowDetail.textContent='-'; remEl.textContent='00:00'; if(bar) bar.style.width='0%'; return; } const ex=currentWorkout.exercises[runner.i]; if(!ex){ nowEx.textContent='ì™„ë£Œ'; nowSet.textContent='-'; nowDetail.textContent='-'; return; } nowEx.textContent=`${ex.name} ${runner.phase==='rest'?'(íœ´ì‹)':''}`; nowSet.textContent=`${runner.set} / ${ex.sets}`; nowDetail.textContent=ex.type==='time'?`${ex.secs}s`:`${runner.rep}/${ex.reps}íšŒ`; }
  function startSession(){ if(!currentWorkout){ alert('í…œí”Œë¦¿ì„ ì„ íƒí•˜ê±°ë‚˜ ë¹ ë¥¸í¸ì§‘ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”.'); return; } ensureAC(); Object.assign(runner,{i:0,set:1,phase:'work',rep:0,repsTarget:0,warnDone:false,paused:false,tempo:0,startSeqFired:false,endSeqFired:false}); statusEl.textContent='ì§„í–‰ ì¤‘'; $('#startBtn').disabled=true; $('#pauseBtn').disabled=false; $('#skipBtn').disabled=false; $('#resetBtn').disabled=false; repBtn.disabled=false; speak(`ìš´ë™ì„ ì‹œì‘í•©ë‹ˆë‹¤. ${currentWorkout.name}`); stepWork(); }
  function stepWork(){ const ex=currentWorkout.exercises[runner.i]; if(!ex) return finishSession(); runner.phase='work'; runner.warnDone=false; runner.endSeqFired=false; markPlayerState(''); if(bar) bar.style.width='0%'; if(ex.type==='time'){ runner.tStart=performance.now(); runner.tEnd=runner.tStart+ex.secs*1000; $('#countdown-label').textContent='ë‚¨ì€ ì‹œê°„'; speak(`${ex.name} ${runner.set}ì„¸íŠ¸ ì‹œì‘`); tick(); } else { runner.rep=0; runner.repsTarget=ex.reps; runner.tempo=ex.tempo||0; $('#countdown-label').textContent='ë°˜ë³µ'; speak(`${ex.name} ${runner.set}ì„¸íŠ¸ ì‹œì‘`); if(voice.countCall&&runner.tempo>0){ scheduleNextRep(); } else { updateUI(); } } }
  function scheduleNextRep(){ const g=runner.gen; const ex=currentWorkout.exercises[runner.i]; if(!ex||runner.phase!=='work') return; if(runner.rep>=runner.repsTarget){ return afterWork(); } runner.timer&&clearTimeout(runner.timer); runner.timer=setTimeout(()=>{ if(runner.gen!==g || runner.phase==='idle') return; runner.rep++; updateUI(); if(voice.countCall) speak(String(runner.rep)); else beep(); if(runner.rep===runner.repsTarget-1){ speak('ë§ˆì§€ë§‰ í•œ ê°œ'); beep(200,600,0.45); } if(runner.rep>=runner.repsTarget){ setTimeout(afterWork,300); } else { scheduleNextRep(); } }, Math.max(10,runner.tempo*1000)); }
  function tick(){ if(runner.paused) return; const g=runner.gen; const now=performance.now(); const remain=Math.max(0,runner.tEnd-now); remEl.textContent=fmtClock(remain/1000); const ex=currentWorkout.exercises[runner.i]; const total=ex.secs*1000; const prog=1-remain/total; if(bar) bar.style.width=`${Math.max(0,Math.min(1,prog))*100}%`; updateUI(); if(!runner.endSeqFired && remain/1000<=3){ runner.endSeqFired=true; speak('ê³§ ì¢…ë£Œí•©ë‹ˆë‹¤'); crescendo('end'); markPlayerState('warn'); }
    if(remain<=0){ afterWork(); return;} runner.timer=requestAnimationFrame(()=>{ if(runner.gen!==g || runner.phase==='idle') return; tick(); }); }
  function afterWork(){ const ex=currentWorkout.exercises[runner.i]; if(ex.rest>0){ runner.phase='rest'; runner.warnDone=false; markPlayerState('rest'); speak('íœ´ì‹ ì‹œì‘'); runner.tStart=performance.now(); runner.tEnd=runner.tStart+ex.rest*1000; $('#countdown-label').textContent='íœ´ì‹ ë‚¨ì€ ì‹œê°„'; tickRest(); } else { nextSetOrExercise(); } }
  function tickRest(){ if(runner.paused) return; const g=runner.gen; const now=performance.now(); const remain=Math.max(0,runner.tEnd-now); remEl.textContent=fmtClock(remain/1000); const ex=currentWorkout.exercises[runner.i]; const total=ex.rest*1000; const prog=1-remain/total; if(bar) bar.style.width=`${Math.max(0,Math.min(1,prog))*100}%`; updateUI(); if(!runner.startSeqFired && remain/1000<=3){ runner.startSeqFired=true; speak('ì¤€ë¹„'); crescendo('start'); markPlayerState('warn'); }
    if(remain<=0){ markPlayerState(''); nextSetOrExercise(); return;} runner.timer=requestAnimationFrame(()=>{ if(runner.gen!==g || runner.phase==='idle') return; tickRest(); }); }
  function nextSetOrExercise(){ const ex=currentWorkout.exercises[runner.i]; if(runner.set<ex.sets){ runner.set++; stepWork(); } else { runner.i++; runner.set=1; if(runner.i>=currentWorkout.exercises.length) finishSession(); else stepWork(); } }
  function pauseSession(){ if(runner.paused) return resumeSession(); runner.paused=true; statusEl.textContent='ì¼ì‹œì •ì§€'; if(runner.timer){ cancelAnimationFrame(runner.timer); clearTimeout(runner.timer);} }
  function resumeSession(){ runner.paused=false; statusEl.textContent='ì§„í–‰ ì¤‘'; const ex=currentWorkout.exercises[runner.i]; if(!ex) return; if(runner.phase==='work'){ if(ex.type==='time') tick(); else scheduleNextRep(); } else if(runner.phase==='rest') tickRest(); }
  function skip(){ if(!currentWorkout) return; if(runner.timer){ cancelAnimationFrame(runner.timer); clearTimeout(runner.timer);} speak('ìŠ¤í‚µí•©ë‹ˆë‹¤'); markPlayerState(''); nextSetOrExercise(); }
  function resetSession(){ runner.gen++; if(runner.timer){ cancelAnimationFrame(runner.timer); clearTimeout(runner.timer);} Object.assign(runner,{i:0,set:1,phase:'idle',rep:0,repsTarget:0,tStart:0,tEnd:0,warnDone:false,paused:false,timer:null,tempo:0,startSeqFired:false,endSeqFired:false}); statusEl.textContent='ëŒ€ê¸°'; $('#startBtn').disabled=false; $('#pauseBtn').disabled=true; $('#skipBtn').disabled=true; $('#resetBtn').disabled=true; repBtn.disabled=true; updateUI(); if(bar) bar.style.width='0%'; remEl.textContent='00:00'; try{ speechSynthesis.cancel(); }catch(e){} markPlayerState(''); }
  function finishSession(){ if(runner.timer){ cancelAnimationFrame(runner.timer); clearTimeout(runner.timer);} statusEl.textContent='ì™„ë£Œ'; speak('ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤. ì›Œí¬ì•„ì›ƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); $('#pauseBtn').disabled=true; $('#skipBtn').disabled=true; repBtn.disabled=true; markPlayerState(''); }

  // Buttons
  $('#startBtn').addEventListener('click',startSession); $('#pauseBtn').addEventListener('click',pauseSession); $('#skipBtn').addEventListener('click',skip); $('#resetBtn').addEventListener('click',resetSession);
  $('#quickStart').addEventListener('click',startSession);
  $('#clearCurrent').addEventListener('click',()=>{ currentWorkout=null; refreshSummary(); resetSession(); });
  $('#editCurrent').addEventListener('click',()=>{ if(!currentWorkout) { openQuickEdit({name:'ìƒˆ ë£¨í‹´',exercises:[]}); } else { openQuickEdit(currentWorkout); } });
  document.addEventListener('keydown',(e)=>{ if(e.code==='Space'&&!repBtn.disabled){ e.preventDefault(); repBtn.click(); } });
  $('#repBtn').addEventListener('click',()=>{ const ex=currentWorkout?.exercises[runner.i]; if(!ex||ex.type!=='reps') return; if(runner.phase!=='work') return; runner.rep++; updateUI(); if(voice.countCall) speak(String(runner.rep)); else beep(); if(runner.rep>=ex.reps){ speak('ê³§ ì¢…ë£Œí•©ë‹ˆë‹¤'); beep(180,900,0.5); setTimeout(afterWork,300); } });

  // GPS
  const gps={id:null,pts:[],dist:0}; function hav(a,b){ const toR=d=>d*Math.PI/180; const R=6371000; const dLat=toR(b.lat-a.lat), dLon=toR(b.lon-a.lon); const lat1=toR(a.lat), lat2=toR(b.lat); const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(Math.abs(dLon)/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }
  function gpsUpdate(pos){ const p={lat:pos.coords.latitude,lon:pos.coords.longitude,t:Date.now()}; const n=gps.pts.length; if(n>0){ gps.dist+=hav(gps.pts[n-1],p);} gps.pts.push(p); $('#gpsPts').textContent=String(gps.pts.length); $('#gpsDist').textContent=(gps.dist/1000).toFixed(2)+' km'; }
  $('#gpsStart').addEventListener('click',()=>{ if(!navigator.geolocation) return alert('ì´ ê¸°ê¸°ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); if(gps.id) return; gps.pts=[]; gps.dist=0; $('#gpsPts').textContent='0'; $('#gpsDist').textContent='0.00 km'; gps.id=navigator.geolocation.watchPosition(gpsUpdate,console.warn,{enableHighAccuracy:true,maximumAge:2000,timeout:10000}); $('#gpsStart').disabled=true; $('#gpsStop').disabled=false; });
  $('#gpsStop').addEventListener('click',()=>{ if(gps.id){ navigator.geolocation.clearWatch(gps.id); gps.id=null; } $('#gpsStart').disabled=false; $('#gpsStop').disabled=true; alert('ê¸°ë¡ëœ ì¢Œí‘œ ìˆ˜: '+gps.pts.length+'\nì´ ê±°ë¦¬: '+(gps.dist/1000).toFixed(2)+' km'); });

  // Voices & settings
  speechSynthesis.onvoiceschanged=()=>{ const sel=$('#setVoice'); if(!sel) return; sel.innerHTML=''; const vs=speechSynthesis.getVoices(); const opts=vs.filter(v=>v.lang&&v.lang.startsWith('ko')); if(opts.length===0){ const o=document.createElement('option'); o.value=''; o.textContent='(ê¸°ë³¸)'; sel.appendChild(o); return; } opts.forEach(v=>{ const o=document.createElement('option'); o.value=v.voiceURI; o.textContent=v.name+' Â· '+v.lang; sel.appendChild(o); }); if(voice.voiceURI){ sel.value=voice.voiceURI; } };
  $('#setTTS')?.addEventListener('change',e=>{ voice.enabled=e.target.value==='on'; });
  $('#setVoice')?.addEventListener('change',e=>{ voice.voiceURI=e.target.value||null; });
  $('#setCountCall')?.addEventListener('change',e=>{ voice.countCall=e.target.value==='on'; });
  $('#setWarn')?.addEventListener('change',e=>{ voice.warnSec=Math.max(0,+e.target.value||3); });

  // PWA: SW register + install prompt
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(console.warn);
    });
  }
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const btn = document.getElementById('installBtn');
    if (btn) btn.style.display = 'inline-flex';
  });
  document.getElementById('installBtn')?.addEventListener('click', async () => {
    const btn = document.getElementById('installBtn');
    if (!deferredPrompt) return;
    btn.disabled = true;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    btn.style.display = 'none';
  });
  window.addEventListener('appinstalled', () => console.log('PWA installed'));
  </script>
</body>
</html>
